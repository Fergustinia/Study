-- Создание триггера для автоматического перенаправления клиентов
CREATE TRIGGER trg_ПеренаправлениеКлиентов
AFTER UPDATE ON СОТРУДНИКИ
FOR EACH ROW
BEGIN
    DECLARE ИЗБЫТОК_КЛИЕНТОВ INT;

    -- Вычисление избытка клиентов
    SET ИЗБЫТОК_КЛИЕНТОВ = NEW.КОЛИЧЕСТВО_КЛИЕНТОВ - 2;

    -- Перенаправление клиентов, если их количество превышает 2
    IF ИЗБЫТОК_КЛИЕНТОВ > 0 THEN
        -- Перенаправление клиентов к другому сотруднику с количеством клиентов меньше 2
        UPDATE КЛИЕНТЫ
        SET СОТРУДНИК_ID = (SELECT СОТРУДНИК_ID FROM СОТРУДНИКИ WHERE КОЛИЧЕСТВО_КЛИЕНТОВ < 2 ORDER BY КОЛИЧЕСТВО_КЛИЕНТОВ LIMIT 1)
        WHERE СОТРУДНИК_ID = NEW.СОТРУДНИК_ID
        AND КОЛИЧЕСТВО_КЛИЕНТОВ > 2
        LIMIT ИЗБЫТОК_КЛИЕНТОВ;

        -- Обновление количества клиентов у сотрудников
        UPDATE СОТРУДНИКИ
        SET КОЛИЧЕСТВО_КЛИЕНТОВ = КОЛИЧЕСТВО_КЛИЕНТОВ - ИЗБЫТОК_КЛИЕНТОВ
        WHERE СОТРУДНИК_ID <> NEW.СОТРУДНИК_ID AND КОЛИЧЕСТВО_КЛИЕНТОВ < 2
        LIMIT ИЗБЫТОК_КЛИЕНТОВ;
    END IF;
END;
